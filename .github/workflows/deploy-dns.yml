name: TEST Deploy DNS Records

on:
  push:
    branches:
      - feat/testing-pdns
    paths:
      - "records/**.json"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Identify Changes
        id: changes
        run: |
          git checkout ${{ github.ref_name }}

          ADDED_FILES=$(git diff --name-status --diff-filter=A HEAD^ HEAD -- 'records/**.json' | cut -f2 | tr '\n' ' ')
          MODIFIED_FILES=$(git diff --name-status --diff-filter=M HEAD^ HEAD -- 'records/**.json' | cut -f2 | tr '\n' ' ')
          DELETED_FILES=$(git diff --name-status --diff-filter=D HEAD^ HEAD -- 'records/**.json' | cut -f2 | tr '\n' ' ')

          echo "Added: $ADDED_FILES"
          echo "Modified: $MODIFIED_FILES"
          echo "Deleted: $DELETED_FILES"

          echo "added_files=$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "modified_files=$MODIFIED_FILES" >> $GITHUB_OUTPUT
          echo "deleted_files=$DELETED_FILES" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm install node-fetch

      - name: Update DNS via Cloudflare API
        env:
          PDNS_API_KEY: ${{secrets.PDNS_API_KEY}}
          PDNS_API_URL: http://pdns-auth:8081/api/v1
          ADDED_FILES: ${{ steps.changes.outputs.added_files }}
          MODIFIED_FILES: ${{ steps.changes.outputs.modified_files }}
          DELETED_FILES: ${{ steps.changes.outputs.deleted_files }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          BASE_DOMAIN: "grrr.site"
        run: node .github/scripts/update-pdns-dns.js
